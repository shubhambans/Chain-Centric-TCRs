# Requires setup from Figure_code/Setup/Setup.R before running.

#ggsignif does not show up unless the axis limits are changed

library(dplyr)

# Compute the percentage of public junctions per donorVisit and chain
CD4merge_public_per_donor <- CD4merge %>%
    group_by(donorVisit, chain) %>%
    summarise(public_junction_count = sum(sharing == "public"),  # Count public junctions
              total_junctions = n(),  # Count total junctions (public + private)
              chainSpecificPercentPublic = (public_junction_count / total_junctions) * 100,  # Compute percentage
              .groups = "drop")

# View the results
head(CD4merge_public_per_donor)
# Merge chain-specific public percentages into indices_combinedByChain
indices_combinedByChain <- indices_combined %>%
    left_join(CD4merge_public_per_donor, by = c("donorVisit", "chain"))

# Check the updated dataset
head(indices_combinedByChain)
library(ggplot2)
library(ggsignif)

# Customizable components based on GRAPHFINAL
violin_fill_color <- "dark grey"
violin_outline_color <- "black"
pointrange_color <- "red"
significance_line_color <- "black"
plot_title <- "Publicity Changes with Disease\n"
x_axis_label <- "\nPatient Type"
y_axis_label <- "Percent of Public TCRs (%)\n"
caption_text <- "Welch's t-test"
angle_x_axis_text <- 45
x_axis_text_hjust <- 1
x_axis_text_vjust <- 1

# Ensure proper ordering of factor levels
indices_combinedByChain$Status <- factor(indices_combinedByChain$Status, levels = c("Healthy", "Covid"))

# Convert 'chain' to factor to ensure proper faceting
indices_combinedByChain$chain <- as.factor(indices_combinedByChain$chain)

# Plot code following GRAPHFINAL
p <- ggplot(data = subset(indices_combinedByChain, Status %in% c("Healthy", "Covid")), aes(x = Status, y = chainSpecificPercentPublic)) +
    geom_violin(trim = FALSE, fill = violin_fill_color, color = violin_outline_color, alpha = 0.7) +  # Violin colors
    labs(title = plot_title, y = y_axis_label, x = x_axis_label) +  # Plot title and axis labels
    stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", colour = pointrange_color, size = 1.8) +  # Dots color with GRAPHFINAL specs
    geom_signif(comparisons = list(c("Healthy", "Covid")), 
                map_signif_level = TRUE, test = "t.test", step_increase = 0.1, color = significance_line_color, size = 1) +  # Significance line
    scale_y_continuous(limits = c(0, 60), breaks = c(0, 25, 50)) +  # Y-axis limits from 0 to 60 with notches at 0, 25, and 50
    labs(caption = caption_text) +  # Caption text
    theme(axis.text.x = element_text(angle = angle_x_axis_text, vjust = x_axis_text_vjust, hjust = x_axis_text_hjust),  # X-axis text angle
          plot.title = element_text(hjust = 0.5),  # Center the title
          legend.position = "none") +  # Remove the redundant legend
    facet_wrap(~chain)  # Facet by TCR chain

# Save the plot as a square image (14x17 inches) with GRAPHFINAL dimensions
ggsave("square_plot.png", plot = p, width = 14, height = 17, units = "in", dpi = 300)
