#the overlay of the random is added artically by cropping removing background and using powerpoint to color differently

library(ggplot2)
library(dplyr)

# Step 1: Subset the metadata for cells with leven_meta between 1 and 5, subtracting 1 to shift labels to 0-4
subset_metadata <- RealBatchCorrectedBacherSeurat@meta.data %>%
    filter(leven_meta %in% c(1, 2, 3, 4, 5)) %>%
    mutate(leven_meta = as.character(leven_meta - 1))  # Subtract 1 to shift labels

# Step 2: Create a random subset of 500 cells
set.seed(319)  # Ensure reproducibility
random_subset <- RealBatchCorrectedBacherSeurat@meta.data %>%
    sample_n(500) %>%
    select(pseudotime)  # Only need pseudotime for plotting

# Step 3: Prepare data for plotting by combining group and random data
leven_meta_levels <- c("0", "1", "2", "3", "4")

# Initialize an empty list to store data for plotting
plot_data_list <- list()

for (leven_level in leven_meta_levels) {
    # Data for the current leven_meta level
    group_data <- subset_metadata %>%
        filter(leven_meta == leven_level) %>%
        select(pseudotime) %>%
        mutate(is_random = FALSE)
    
    # Random subset data, marked as random
    random_data <- random_subset %>%
        mutate(is_random = TRUE)
    
    # Combine group and random data, assign current leven_meta level
    combined_data <- bind_rows(group_data, random_data) %>%
        mutate(leven_meta = leven_level)
    
    # Add combined data to the list
    plot_data_list[[leven_level]] <- combined_data
}

# Combine all data into one dataframe
plot_data <- bind_rows(plot_data_list)

# Step 4: Create the facet plot with overlaid densities
p <- ggplot(plot_data, aes(x = pseudotime, fill = is_random)) +
    geom_density(alpha = 0.5, color = NA) +  # Overlay densities with transparency
    scale_fill_manual(
        values = c("FALSE" = "green", "TRUE" = "darkgrey"),
        labels = c("# of Mismatches", "Random"),
        name = "Data Source"
    ) +
    labs(
        title = "Pseudotime Distribution of Cells\n",
        x = "Pseudotime\n",
        y = "Density of Cells\n"
    ) +
    facet_wrap(~leven_meta, ncol = 2) +  # Create 5 panels for leven_meta levels 0-4
    theme(
        plot.title = element_text(hjust = 0.5, face = "bold"),  # Center and bold title
        axis.title.x = element_text(face = "bold"),             # Bold x-axis title
        axis.title.y = element_text(face = "bold")              # Bold y-axis title
    )

# Step 5: Save the plot with specified dimensions
ggsave("Pseudotime_Distribution_GraphFinal.png", plot = p, width = 15, height = 17, units = "in", dpi = 300)

